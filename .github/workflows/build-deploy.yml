name: Build and Deploy Flatpak

on:
  # 1. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub (–≤–∫–ª–∞–¥–∫–∞ Actions)
  workflow_dispatch:
    inputs:
      manifest_name:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: com.app.MyApp.json)'
        required: true
        default: ''
      run_update:
        description: '–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è? (true/false)'
        required: true
        default: 'false'
      github_repo_source:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: user/repo)'
        required: false
        default: ''

  # 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ manifests
  push:
    paths:
      - 'manifests/*.json'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º flatpak-builder
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-22.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          dnf install -y jq rsync curl openssh

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–∞—à –∫–ª—é—á –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --passphrase "" 2>/dev/null || true

      # --- –ë–õ–û–ö –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–ï–†–°–ò–ò ---
      - name: Update Manifest Version
        if: github.event.inputs.run_update == 'true'
        env:
          MANIFEST_NAME: ${{ github.event.inputs.manifest_name }}
          SOURCE_REPO: ${{ github.event.inputs.github_repo_source }}
        run: |
          chmod +x scripts/update_manifest.sh
          ./scripts/update_manifest.sh "$SOURCE_REPO" "manifests/$MANIFEST_NAME"

      # --- –ë–õ–û–ö –°–ë–û–†–ö–ò ---
      - name: Determine Manifest to Build
        id: vars
        env:
          INPUT_MANIFEST: ${{ github.event.inputs.manifest_name }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ñ–∞–π–ª —Å–æ–±–∏—Ä–∞—Ç—å
          if [ -n "$INPUT_MANIFEST" ]; then
            MANIFEST_PATH="manifests/$INPUT_MANIFEST"
          else
            # –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª push, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            MANIFEST_PATH=$(ls manifests/*.json | head -n 1)
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç: $MANIFEST_PATH"
          fi
          
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "–û—à–∏–±–∫–∞: –ú–∞–Ω–∏—Ñ–µ—Å—Ç $MANIFEST_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "manifest_path=$MANIFEST_PATH" >> $GITHUB_OUTPUT
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          APP_ID=$(jq -r '.id // ."app-id"' "$MANIFEST_PATH")
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      - name: Build and Sign Flatpak
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          MANIFEST="${{ steps.vars.outputs.manifest_path }}"
          APP_ID="${{ steps.vars.outputs.app_id }}"
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É: $APP_ID"
          
          # 1. –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          flatpak-builder --repo=repo --force-clean --gpg-sign=$GPG_KEY_ID build-dir "$MANIFEST"
          
          # 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          flatpak build-update-repo --generate-static-deltas --gpg-sign=$GPG_KEY_ID --title="Flat Store" repo
          
          # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .flatpakref —Ñ–∞–π–ª–∞
          GPG_PUBLIC_DATA=$(gpg --export --armor $GPG_KEY_ID | base64 -w 0)
          mkdir -p repo/apps
          FLATPAKREF_FILE="repo/apps/$(basename "$APP_ID" | tr '.' '-').flatpakref"
          
          cat <<EOF > "$FLATPAKREF_FILE"
          [Flatpak Ref]
          Name=$APP_ID/x86_64/master
          RepoName=Flat Store
          Url=https://flatstore.ikhlasulov.site/flatstore/
          RuntimeRepo=https://dl.flathub.org/repo/flathub.flatpakrepo
          IsRuntime=false
          SuggestRemoteName=flatstore
          GPGKey=$GPG_PUBLIC_DATA
          EOF
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      # --- –ë–õ–û–ö –î–ï–ü–õ–û–Ø –ù–ê –°–ï–†–í–ï–† ---
      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á —Ö–æ—Å—Ç–∞ –≤ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
          ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
          
          echo "üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä $REMOTE_HOST..."
          
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: —É–¥–∞–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–±–æ—Ä–∫–µ (--delete)
          rsync -avz --delete ./repo/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/
          
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ."
