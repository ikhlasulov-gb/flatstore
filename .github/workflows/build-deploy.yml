name: Build and Deploy Flatpak

on:
  workflow_dispatch:
    inputs:
      manifest_name:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: com.app.MyApp.json)'
        required: true
        default: ''
      run_update:
        description: '–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è? (true/false)'
        required: true
        default: 'false'
      github_repo_source:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)'
        required: false
        default: ''

  push:
    paths:
      - 'manifests/*.json'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-22.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω—É–∂–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –≤–∫–ª—é—á–∞—è lftp –¥–ª—è FTP-–¥–µ–ø–ª–æ—è
          dnf install -y jq rsync curl openssh lftp

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --passphrase "" 2>/dev/null || true

      - name: Add Flathub Repository
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Update Manifest Version
        if: github.event.inputs.run_update == 'true'
        env:
          MANIFEST_NAME: ${{ github.event.inputs.manifest_name }}
          SOURCE_REPO: ${{ github.event.inputs.github_repo_source }}
        run: |
          chmod +x scripts/update_manifest.sh
          ./scripts/update_manifest.sh "$SOURCE_REPO" "manifests/$MANIFEST_NAME"

      - name: Determine Manifest to Build
        id: vars
        env:
          INPUT_MANIFEST: ${{ github.event.inputs.manifest_name }}
        run: |
          if [ -n "$INPUT_MANIFEST" ]; then
            MANIFEST_PATH="manifests/$INPUT_MANIFEST"
          else
            MANIFEST_PATH=$(ls manifests/*.json | head -n 1)
          fi
          
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "–û—à–∏–±–∫–∞: –ú–∞–Ω–∏—Ñ–µ—Å—Ç $MANIFEST_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "manifest_path=$MANIFEST_PATH" >> $GITHUB_OUTPUT
          APP_ID=$(jq -r '.id // ."app-id"' "$MANIFEST_PATH")
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      - name: Build and Sign Flatpak
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          MANIFEST="${{ steps.vars.outputs.manifest_path }}"
          APP_ID="${{ steps.vars.outputs.app_id }}"
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É: $APP_ID"
          
          flatpak-builder --repo=repo --force-clean --gpg-sign=$GPG_KEY_ID --install-deps-from=flathub build-dir "$MANIFEST"
          flatpak build-update-repo --generate-static-deltas --gpg-sign=$GPG_KEY_ID --title="Flat Store" repo
          
          GPG_PUBLIC_DATA=$(gpg --export --armor $GPG_KEY_ID | base64 -w 0)
          mkdir -p repo/apps
          FLATPAKREF_FILE="repo/apps/$(basename "$APP_ID" | tr '.' '-').flatpakref"
          
          cat <<EOF > "$FLATPAKREF_FILE"
          [Flatpak Ref]
          Name=$APP_ID/x86_64/master
          RepoName=Flat Store
          Url=https://flatstore.ikhlasulov.site/flatstore/
          RuntimeRepo=https://dl.flathub.org/repo/flathub.flatpakrepo
          IsRuntime=false
          SuggestRemoteName=flatstore
          GPGKey=$GPG_PUBLIC_DATA
          EOF
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      # --- –ù–û–í–´–ô –®–ê–ì –î–ï–ü–õ–û–Ø –ß–ï–†–ï–ó FTP (lftp) ---
      - name: Deploy via FTP
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PASSWORD: ${{ secrets.REMOTE_PASSWORD }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }} # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ IP —Å–µ—Ä–≤–µ—Ä–∞ (172.104.186.57)
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }} # –ù–∞–ø—Ä–∏–º–µ—Ä: /public_html/flatstore...
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }} # –£–∫–∞–∂–∏—Ç–µ 21 (–∏–ª–∏ –≤–∞—à FTP –ø–æ—Ä—Ç)
        run: |
          echo "üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ FTP —Å–µ—Ä–≤–µ—Ä—É $REMOTE_HOST..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º lftp –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          # -e "–∫–æ–º–∞–Ω–¥—ã" - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ –≤—ã—Ö–æ–¥–∏—Ç
          # set ftp:ssl-allow no - –æ—Ç–∫–ª—é—á–∞–µ—Ç SSL (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å yes)
          # mirror -R - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          # --delete - —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ (—á—Ç–æ–±—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±—ã–ª —á–∏—Å—Ç—ã–º)
          
          lftp -u "$REMOTE_USER","$REMOTE_PASSWORD" -p "${REMOTE_PORT:-21}" "$REMOTE_HOST" <<EOF
          set ftp:ssl-allow no
          set ftp:passive-mode on
          mirror -R --delete ./repo/ "$REMOTE_PATH"
          quit
          EOF
          
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ."
