name: Build and Deploy Flatpak

on:
  workflow_dispatch:
    inputs:
      manifest_name:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: com.app.MyApp.json)'
        required: true
        default: ''
      run_update:
        description: '–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è? (true/false)'
        required: true
        default: 'false'
      github_repo_source:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)'
        required: false
        default: ''

  push:
    paths:
      - 'manifests/*.json'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-22.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq, rsync, openssh –∏ sshpass (–¥–ª—è –ø–∞—Ä–æ–ª—è)
          dnf install -y jq rsync curl openssh sshpass

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --passphrase "" 2>/dev/null || true

      - name: Add Flathub Repository
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Update Manifest Version
        if: github.event.inputs.run_update == 'true'
        env:
          MANIFEST_NAME: ${{ github.event.inputs.manifest_name }}
          SOURCE_REPO: ${{ github.event.inputs.github_repo_source }}
        run: |
          chmod +x scripts/update_manifest.sh
          ./scripts/update_manifest.sh "$SOURCE_REPO" "manifests/$MANIFEST_NAME"

      - name: Determine Manifest to Build
        id: vars
        env:
          INPUT_MANIFEST: ${{ github.event.inputs.manifest_name }}
        run: |
          if [ -n "$INPUT_MANIFEST" ]; then
            MANIFEST_PATH="manifests/$INPUT_MANIFEST"
          else
            MANIFEST_PATH=$(ls manifests/*.json | head -n 1)
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç: $MANIFEST_PATH"
          fi
          
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "–û—à–∏–±–∫–∞: –ú–∞–Ω–∏—Ñ–µ—Å—Ç $MANIFEST_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "manifest_path=$MANIFEST_PATH" >> $GITHUB_OUTPUT
          APP_ID=$(jq -r '.id // ."app-id"' "$MANIFEST_PATH")
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      - name: Build and Sign Flatpak
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          MANIFEST="${{ steps.vars.outputs.manifest_path }}"
          APP_ID="${{ steps.vars.outputs.app_id }}"
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É: $APP_ID"
          
          flatpak-builder --repo=repo --force-clean --gpg-sign=$GPG_KEY_ID --install-deps-from=flathub build-dir "$MANIFEST"
          flatpak build-update-repo --generate-static-deltas --gpg-sign=$GPG_KEY_ID --title="Flat Store" repo
          
          GPG_PUBLIC_DATA=$(gpg --export --armor $GPG_KEY_ID | base64 -w 0)
          mkdir -p repo/apps
          FLATPAKREF_FILE="repo/apps/$(basename "$APP_ID" | tr '.' '-').flatpakref"
          
          cat <<EOF > "$FLATPAKREF_FILE"
          [Flatpak Ref]
          Name=$APP_ID/x86_64/master
          RepoName=Flat Store
          Url=https://flatstore.ikhlasulov.site/flatstore/
          RuntimeRepo=https://dl.flathub.org/repo/flathub.flatpakrepo
          IsRuntime=false
          SuggestRemoteName=flatstore
          GPGKey=$GPG_PUBLIC_DATA
          EOF
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      # --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –®–ê–ì –î–ï–ü–õ–û–Ø (–° –ü–ê–†–û–õ–ï–ú –ò –ü–û–†–¢–û–ú) ---
      - name: Deploy to Server
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }} # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç —Ä–∞–≤–µ–Ω 64000
          REMOTE_PASSWORD: ${{ secrets.REMOTE_PASSWORD }} # –í–∞—à –ø–∞—Ä–æ–ª—å –æ—Ç cPanel
        run: |
          echo "üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $REMOTE_HOST:$REMOTE_PORT..."
          
          # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–∞—Ä–æ–ª—è, —á—Ç–æ–±—ã sshpass –µ–µ —É–≤–∏–¥–µ–ª
          export SSHPASS="$REMOTE_PASSWORD"
          
          # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º sshpass –∏ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—Ç)
          sshpass -e ssh -o StrictHostKeyChecking=no -p "$REMOTE_PORT" $REMOTE_USER@$REMOTE_HOST "echo '‚úÖ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!'" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å –∏ –ø–æ—Ä—Ç."; exit 1; }
          
          echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤..."
          # 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ (sshpass –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—Å—Ç –ø–∞—Ä–æ–ª—å)
          sshpass -e rsync -avz -e "ssh -o StrictHostKeyChecking=no -p $REMOTE_PORT" --delete ./repo/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/
          
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ."
