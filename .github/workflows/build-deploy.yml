name: Build and Deploy Flatpak

on:
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:
    inputs:
      manifest_name:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: com.app.MyApp.json)'
        required: true
        default: ''
      run_update:
        description: '–û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è? (true/false)'
        required: true
        default: 'false'
      github_repo_source:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: user/repo)'
        required: false
        default: ''

  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
  push:
    paths:
      - 'manifests/*.json'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ flatpak-builder
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-22.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          dnf install -y jq rsync curl openssh

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --passphrase "" 2>/dev/null || true

      # --- –®–ê–ì: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Flathub ---
      # –≠—Ç–æ—Ç —à–∞–≥ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —á—Ç–æ–±—ã flatpak-builder –º–æ–≥ –Ω–∞–π—Ç–∏ SDK, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ
      - name: Add Flathub Repository
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      # --- –®–ê–ì: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ) ---
      - name: Update Manifest Version
        if: github.event.inputs.run_update == 'true'
        env:
          MANIFEST_NAME: ${{ github.event.inputs.manifest_name }}
          SOURCE_REPO: ${{ github.event.inputs.github_repo_source }}
        run: |
          chmod +x scripts/update_manifest.sh
          ./scripts/update_manifest.sh "$SOURCE_REPO" "manifests/$MANIFEST_NAME"

      # --- –®–ê–ì: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ ---
      - name: Determine Manifest to Build
        id: vars
        env:
          INPUT_MANIFEST: ${{ github.event.inputs.manifest_name }}
        run: |
          if [ -n "$INPUT_MANIFEST" ]; then
            MANIFEST_PATH="manifests/$INPUT_MANIFEST"
          else
            # –ï—Å–ª–∏ —ç—Ç–æ push, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            MANIFEST_PATH=$(ls manifests/*.json | head -n 1)
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç: $MANIFEST_PATH"
          fi
          
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "–û—à–∏–±–∫–∞: –ú–∞–Ω–∏—Ñ–µ—Å—Ç $MANIFEST_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "manifest_path=$MANIFEST_PATH" >> $GITHUB_OUTPUT
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          APP_ID=$(jq -r '.id // ."app-id"' "$MANIFEST_PATH")
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT

      # --- –®–ê–ì: –°–±–æ—Ä–∫–∞ ---
      - name: Build and Sign Flatpak
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          MANIFEST="${{ steps.vars.outputs.manifest_path }}"
          APP_ID="${{ steps.vars.outputs.app_id }}"
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É: $APP_ID"
          
          # –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: --install-deps-from=flathub –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç –Ω—É–∂–Ω—ã–π SDK (–Ω–∞–ø—Ä–∏–º–µ—Ä, 49-–π)
          flatpak-builder --repo=repo --force-clean --gpg-sign=$GPG_KEY_ID --install-deps-from=flathub build-dir "$MANIFEST"
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          flatpak build-update-repo --generate-static-deltas --gpg-sign=$GPG_KEY_ID --title="Flat Store" repo
          
          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .flatpakref
          GPG_PUBLIC_DATA=$(gpg --export --armor $GPG_KEY_ID | base64 -w 0)
          mkdir -p repo/apps
          FLATPAKREF_FILE="repo/apps/$(basename "$APP_ID" | tr '.' '-').flatpakref"
          
          cat <<EOF > "$FLATPAKREF_FILE"
          [Flatpak Ref]
          Name=$APP_ID/x86_64/master
          RepoName=Flat Store
          Url=https://flatstore.ikhlasulov.site/flatstore/
          RuntimeRepo=https://dl.flathub.org/repo/flathub.flatpakrepo
          IsRuntime=false
          SuggestRemoteName=flatstore
          GPGKey=$GPG_PUBLIC_DATA
          EOF
          
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      # --- –®–ê–ì: –î–µ–ø–ª–æ–π ---
      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á —Ö–æ—Å—Ç–∞
          ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
          
          echo "üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä $REMOTE_HOST..."
          rsync -avz --delete ./repo/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/
          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ."
